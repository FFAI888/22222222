<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DApp登录页 v0.12</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg,#a1c4fd,#c2e9fb);
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    margin:0;
}
.card {
    background:#fff;
    border-radius:20px;
    padding:30px 20px;
    max-width:400px;
    width:90%;
    text-align:center;
    box-shadow:0 15px 40px rgba(0,0,0,0.2);
    transition: transform 0.4s ease, opacity 0.4s ease;
    animation: fadeIn 1s ease-out;
    position: relative;
}
.card.hide { opacity:0; transform:translateY(-30px); pointer-events:none; }
h1 { color:#333; margin-bottom:25px; }

button {
    width:100%;
    padding:15px;
    font-size:18px;
    margin:10px 0;
    border:none;
    border-radius:12px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition: all 0.25s ease;
    color:#fff;
    font-weight:bold;
    background-size:200% 200%;
}
button img { width:24px; height:24px; margin-right:10px; }
button:disabled { opacity:0.6; cursor:not-allowed; }

/* 渐变按钮 */
#connectMetaMaskBtn { background-image: linear-gradient(45deg,#f6851b,#e2761b); }
#connectMetaMaskBtn:hover { background-position:right center; transform:scale(1.05); }
#connectWalletConnectBtn { background-image: linear-gradient(45deg,#3b99fc,#2a82f5); }
#connectWalletConnectBtn:hover { background-position:right center; transform:scale(1.05); }
#signLoginBtn { background-image: linear-gradient(45deg,#28a745,#218838); }
#signLoginBtn:hover { background-position:right center; transform:scale(1.05); }

#walletInfo {
    margin-top:20px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:16px;
    background:#f0f4f8;
    border-radius:12px;
    padding:10px 15px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    transition: background 0.3s;
}
#walletInfo img { width:36px; height:36px; margin-right:10px; border-radius:50%; border:1px solid #ccc; }
#walletInfo:hover { background:#e2ebf5; }

#loginStatus { margin-top:15px; font-size:16px; font-weight:bold; }
#toast { visibility:hidden; min-width:200px; background:#333; color:#fff; text-align:center; border-radius:8px; padding:10px; position:fixed; bottom:50px; left:50%; transform:translateX(-50%); z-index:100; font-size:14px; }
#toast.show { visibility:visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

@keyframes fadein { from{bottom:20px;opacity:0;} to{bottom:50px;opacity:1;} }
@keyframes fadeout { from{bottom:50px;opacity:1;} to{bottom:20px;opacity:0;} }
@keyframes fadeIn { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
</style>
</head>
<body>
<div class="card" id="loginCard">
<h1>DApp 登录</h1>
<button id="connectMetaMaskBtn"><img src="https://raw.githubusercontent.com/MetaMask/brand-resources/master/SVG/metamask-fox.svg">连接 MetaMask</button>
<button id="connectWalletConnectBtn"><img src="https://walletconnect.org/walletconnect-logo.svg">使用 WalletConnect</button>
<button id="signLoginBtn" disabled>签名登录</button>

<div id="walletInfo">
    <img id="walletAvatar" src="https://via.placeholder.com/36" alt="钱包图标">
    <span id="walletAddress">钱包未连接</span>
</div>
<p id="loginStatus">未登录</p>
</div>
<div class="card hide" id="successCard">
<h1>登录成功</h1>
<div id="walletInfoSuccess">
    <img id="walletAvatarSuccess" src="https://via.placeholder.com/36" alt="钱包图标">
    <span id="walletAddressSuccess">地址/ENS</span>
</div>
<p id="loginStatusSuccess">已登录</p>
</div>
<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

<script>
let web3, accounts, provider, connectedWallet='';
const loginCard=document.getElementById('loginCard');
const successCard=document.getElementById('successCard');
const walletAddressSpan=document.getElementById('walletAddress');
const walletAvatar=document.getElementById('walletAvatar');
const loginStatus=document.getElementById('loginStatus');
const walletAddressSuccess=document.getElementById('walletAddressSuccess');
const walletAvatarSuccess=document.getElementById('walletAvatarSuccess');
const loginStatusSuccess=document.getElementById('loginStatusSuccess');
const connectMetaMaskBtn=document.getElementById('connectMetaMaskBtn');
const connectWalletConnectBtn=document.getElementById('connectWalletConnectBtn');
const signLoginBtn=document.getElementById('signLoginBtn');
const toast=document.getElementById('toast');

function showToast(msg){toast.innerText=msg; toast.className="show"; setTimeout(()=>{toast.className=toast.className.replace("show","");},3000);}
function shortAddress(addr){return addr.slice(0,6)+"..."+addr.slice(-4);}
async function getENS(address){ try{ const name=await web3.eth.ens.getName(address); if(name && name.name) return name.name; }catch(e){} return null; }

async function updateWalletInfo(addr,type){ 
    let ensName=await getENS(addr);
    let displayName=ensName?ensName:shortAddress(addr);
    walletAddressSpan.innerText=displayName;
    walletAvatar.src=type==='MetaMask'?"https://raw.githubusercontent.com/MetaMask/brand-resources/master/SVG/metamask-fox.svg":"https://walletconnect.org/walletconnect-logo.svg";
    walletAddressSuccess.innerText=displayName;
    walletAvatarSuccess.src=walletAvatar.src;
}

async function connectMetaMask(auto=false){
    if(typeof window.ethereum!=='undefined'){
        try{
            accounts=await window.ethereum.request({method:'eth_requestAccounts'});
            web3=new Web3(window.ethereum);
            connectedWallet='MetaMask';
            connectMetaMaskBtn.disabled=true;
            signLoginBtn.disabled=false;
            await updateWalletInfo(accounts[0],'MetaMask');
            if(auto) loginStatus.innerText='自动登录';
            showToast('MetaMask连接成功');
            localStorage.setItem('connectedWallet','MetaMask');
            localStorage.setItem('walletAddress',accounts[0]);
        }catch(err){console.error(err); if(!auto) showToast('MetaMask连接失败');}
    }else showToast('未检测到 MetaMask');
}
connectMetaMaskBtn.addEventListener('click',()=>connectMetaMask());

async function connectWalletConnect(auto=false){
    try{
        provider=new WalletConnectProvider.default({infuraId:"1c83e5c1f41e4c1fb07ff9c9c7b74e7b"});
        await provider.enable();
        web3=new Web3(provider);
        accounts=await web3.eth.getAccounts();
        connectedWallet='WalletConnect';
        connectWalletConnectBtn.disabled=true;
        signLoginBtn.disabled=false;
        await updateWalletInfo(accounts[0],'WalletConnect');
        showToast('WalletConnect连接成功');
        localStorage.setItem('connectedWallet','WalletConnect');
        localStorage.setItem('walletAddress',accounts[0]);
        if(auto) loginStatus.innerText='自动登录';
        provider.on("disconnect",()=>{
            walletAddressSpan.innerText="钱包未连接";
            walletAvatar.src="https://via.placeholder.com/36";
            loginStatus.innerText='未登录';
            signLoginBtn.disabled=true;
            connectWalletConnectBtn.disabled=false;
            localStorage.removeItem('connectedWallet');
            localStorage.removeItem('walletAddress');
            showToast('钱包已断开');
        });
    }catch(err){console.error(err); showToast('WalletConnect连接失败');}
}
connectWalletConnectBtn.addEventListener('click',()=>connectWalletConnect());

async function signLogin(){
    if(!accounts || accounts.length===0) return;
    const address=accounts[0];
    const nonce="登录验证随机数："+Math.floor(Math.random()*1000000);
    try{
        const signature=await web3.eth.personal.sign(nonce,address);
        loginStatus.innerText='签名成功，已登录';
        loginStatusSuccess.innerText='已登录';
        showCard(successCard);
        localStorage.setItem('walletSigned','true');
        showToast('签名登录成功');
        console.log('地址:',address,'签名:',signature,'nonce:',nonce);
    }catch(err){console.error(err); loginStatus.innerText='签名登录失败'; showToast('签名登录失败');}
}
signLoginBtn.addEventListener('click',signLogin);

function showCard(card){ loginCard.classList.add('hide'); successCard.classList.remove('hide'); }

window.addEventListener('load',async()=>{
    const savedWallet=localStorage.getItem('connectedWallet');
    const savedAddress=localStorage.getItem('walletAddress');
    const walletSigned=localStorage.getItem('walletSigned');
    if(savedWallet && savedAddress){
        if(savedWallet==='MetaMask') await connectMetaMask(true);
        else if(savedWallet==='WalletConnect') await connectWalletConnect(true);
        if(walletSigned==='true') showCard(successCard);
    }
});
</script>
</body>
</html>
